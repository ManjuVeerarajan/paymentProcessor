package com.mobpay.Payment;


import java.util.HashMap;

import org.apache.commons.codec.binary.Base64;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.core.annotation.Order;
import org.springframework.stereotype.Component;

import com.mobpay.Payment.Service.GlobalConstants;

import net.sargue.mailgun.Configuration;
import net.sargue.mailgun.Mail;

@Component
@Order(2)
public class EmailUtility {

	private static final Logger log = LoggerFactory.getLogger(EmailUtility.class);
    public void sentEmail(String message, DbConfig dbConfig){
    	log.info("Inside EmailUtility");     
    	HashMap<String, String> valueFromDB = dbConfig.getValueFromDB();
    	try {
            Configuration configuration = new Configuration()
                    .domain(valueFromDB.get(GlobalConstants.MAILGUN_DOMAIN))
                    .apiKey(valueFromDB.get(GlobalConstants.MAILGUN_API_KEY))
                    .from("CreditChecker Error Log", valueFromDB.get(GlobalConstants.MAILGUN_FROM_EMAILS));
//            String htmlMsg = "<!doctype html><html xmlns=\"http://www.w3.org/1999/xhtml\" xmlns:v=\"urn:schemas-microsoft-com:vml\" xmlns:o=\"urn:schemas-microsoft-com:office:office\"><head><title></title><!--[if !mso]><!--><meta http-equiv=\"X-UA-Compatible\" content=\"IE=edge\"><!--<![endif]--><meta http-equiv=\"Content-Type\" content=\"text/html; charset=UTF-8\"><meta name=\"viewport\" content=\"width=device-width,initial-scale=1\"><style type=\"text/css\">#outlook a{padding:0}body{margin:0;padding:0;-webkit-text-size-adjust:100%;-ms-text-size-adjust:100%}table,td{border-collapse:collapse;mso-table-lspace:0;mso-table-rspace:0}img{border:0;height:auto;line-height:100%;outline:0;text-decoration:none;-ms-interpolation-mode:bicubic}p{display:block;margin:13px 0}</style><!--[if mso]>\r\n<noscript>\r\n<xml>\r\n<o:OfficeDocumentSettings><o:AllowPNG/>\r\n<o:PixelsPerInch>96</o:PixelsPerInch>\r\n</o:OfficeDocumentSettings>\r\n</xml>\r\n</noscript>\r\n<![endif]--><!--[if lte mso 11]>\r\n<style type=\"text/css\">\r\n.mj-outlook-group-fix { width:100% !important; }\r\n</style>\r\n<![endif]--><!--[if !mso]><!--><link href=\"https://fonts.googleapis.com/css2?family=Baloo+2:wght@400;500;600;700;800&display=swap\" rel=\"stylesheet\" type=\"text/css\"><style type=\"text/css\">@import url(https://fonts.googleapis.com/css2?family=Baloo+2:wght@400;500;600;700;800&display=swap);</style><!--<![endif]--><style type=\"text/css\">@media only screen and (min-width:480px){.mj-column-per-100{width:100%!important;max-width:100%}}</style><style media=\"screen and (min-width:480px)\">.moz-text-html .mj-column-per-100{width:100%!important;max-width:100%}</style><style type=\"text/css\">@media only screen and (max-width:480px){table.mj-full-width-mobile{width:100%!important}td.mj-full-width-mobile{width:auto!important}}</style><style type=\"text/css\"></style></head><body style=\"word-spacing:normal;background-color:#e2e8f0\"><div style=\"background-color:#e2e8f0\"><!-- Component: Base Header --><!--[if mso | IE]><table align=\"center\" border=\"0\" cellpadding=\"0\" cellspacing=\"0\" class=\"\" role=\"presentation\" style=\"width:600px;\" width=\"600\" bgcolor=\"transparent\" ><tr><td style=\"line-height:0px;font-size:0px;mso-line-height-rule:exactly;\"><![endif]--><div style=\"background:0 0;background-color:transparent;margin:0 auto;max-width:600px\"><table align=\"center\" border=\"0\" cellpadding=\"0\" cellspacing=\"0\" role=\"presentation\" style=\"background:0 0;background-color:transparent;width:100%\"><tbody><tr><td style=\"direction:ltr;font-size:0;padding:0;text-align:center\"><!--[if mso | IE]><table role=\"presentation\" border=\"0\" cellpadding=\"0\" cellspacing=\"0\"><tr><td class=\"\" style=\"vertical-align:top;width:600px;\" ><![endif]--><div class=\"mj-column-per-100 mj-outlook-group-fix\" style=\"font-size:0;text-align:left;direction:ltr;display:inline-block;vertical-align:top;width:100%\"><table border=\"0\" cellpadding=\"0\" cellspacing=\"0\" role=\"presentation\" width=\"100%\"><tbody><tr><td style=\"vertical-align:top;padding:32px\"><table border=\"0\" cellpadding=\"0\" cellspacing=\"0\" role=\"presentation\" width=\"100%\"><tbody><tr><td align=\"center\" style=\"font-size:0;padding:0;word-break:break-word\"><table border=\"0\" cellpadding=\"0\" cellspacing=\"0\" role=\"presentation\" style=\"border-collapse:collapse;border-spacing:0\"><tbody><tr><td style=\"width:110px\"><img alt=\"AiraPay\" height=\"auto\" src=\"https://moby-common.oss-ap-southeast-3.aliyuncs.com/platform/logo/logo.svg\" style=\"border:0;display:block;outline:0;text-decoration:none;height:auto;width:100%;font-size:13px\" width=\"110\"></td></tr></tbody></table></td></tr></tbody></table></td></tr></tbody></table></div><!--[if mso | IE]></td></tr></table><![endif]--></td></tr></tbody></table></div><!--[if mso | IE]></td></tr></table><![endif]--><!-- Component: Base Top Content Spacer --><!--[if mso | IE]><table align=\"center\" border=\"0\" cellpadding=\"0\" cellspacing=\"0\" class=\"\" role=\"presentation\" style=\"width:600px;\" width=\"600\" bgcolor=\"#F8FAFC\" ><tr><td style=\"line-height:0px;font-size:0px;mso-line-height-rule:exactly;\"><![endif]--><div style=\"background:#f8fafc;background-color:#f8fafc;margin:0 auto;border-radius:18px 18px 0 0;max-width:600px\"><table align=\"center\" border=\"0\" cellpadding=\"0\" cellspacing=\"0\" role=\"presentation\" style=\"background:#f8fafc;background-color:#f8fafc;width:100%;border-radius:18px 18px 0 0\"><tbody><tr><td style=\"direction:ltr;font-size:0;padding:0;text-align:center\"><!--[if mso | IE]><table role=\"presentation\" border=\"0\" cellpadding=\"0\" cellspacing=\"0\"><tr><td class=\"\" style=\"vertical-align:top;width:600px;\" ><![endif]--><div class=\"mj-column-per-100 mj-outlook-group-fix\" style=\"font-size:0;text-align:left;direction:ltr;display:inline-block;vertical-align:top;width:100%\"><table border=\"0\" cellpadding=\"0\" cellspacing=\"0\" role=\"presentation\" style=\"vertical-align:top\" width=\"100%\"><tbody><tr><td style=\"font-size:0;word-break:break-word\"><div style=\"height:36px;line-height:36px\">&#8202;</div></td></tr></tbody></table></div><!--[if mso | IE]></td></tr></table><![endif]--></td></tr></tbody></table></div><!--[if mso | IE]></td></tr></table><![endif]--><!-- Content --><!--[if mso | IE]><table align=\"center\" border=\"0\" cellpadding=\"0\" cellspacing=\"0\" class=\"\" role=\"presentation\" style=\"width:600px;\" width=\"600\" bgcolor=\"#F8FAFC\" ><tr><td style=\"line-height:0px;font-size:0px;mso-line-height-rule:exactly;\"><![endif]--><div style=\"background:#f8fafc;background-color:#f8fafc;margin:0 auto;max-width:600px\"><table align=\"center\" border=\"0\" cellpadding=\"0\" cellspacing=\"0\" role=\"presentation\" style=\"background:#f8fafc;background-color:#f8fafc;width:100%\"><tbody><tr><td style=\"direction:ltr;font-size:0;padding:0;padding-left:24px;padding-right:24px;text-align:center\"><!--[if mso | IE]><table role=\"presentation\" border=\"0\" cellpadding=\"0\" cellspacing=\"0\"><tr><td class=\"\" style=\"vertical-align:top;width:552px;\" ><![endif]--><div class=\"mj-column-per-100 mj-outlook-group-fix\" style=\"font-size:0;text-align:left;direction:ltr;display:inline-block;vertical-align:top;width:100%\"><table border=\"0\" cellpadding=\"0\" cellspacing=\"0\" role=\"presentation\" style=\"vertical-align:top\" width=\"100%\"><tbody><tr><td align=\"left\" style=\"font-size:0;padding:0;padding-bottom:24px;word-break:break-word\"><div style=\"font-family:'Baloo 2',Helvetica,Arial,Sans-Serif;font-size:14px;font-weight:500;line-height:1.4;text-align:left;color:#334155\">Hi Team<strong></strong></div></td></tr><tr><td align=\"left\" style=\"font-size:0;padding:0;padding-bottom:16px;word-break:break-word\"><div style=\"font-family:'Baloo 2',Helvetica,Arial,Sans-Serif;font-size:24px;font-weight:700;line-height:1.4;text-align:left;color:#334155\"></div></td></tr><tr><td align=\"left\" style=\"font-size:0;padding:0;padding-bottom:16px;word-break:break-word\"><div style=\"font-family:'Baloo 2',Helvetica,Arial,Sans-Serif;font-size:14px;font-weight:500;line-height:1.4;text-align:left;color:#334155\">CreditChecker Server has stopped working. Please check immediately</div></td></tr><tr><td align=\"left\" style=\"font-size:0;padding:0;padding-bottom:24px;word-break:break-word\"><div style=\"font-family:'Baloo 2',Helvetica,Arial,Sans-Serif;font-size:14px;font-weight:500;line-height:1.4;text-align:left;color:#334155\">Logs : [{{experian::fail_log}}]</div></td></tr></tbody></table></div></td></tr></tbody></table></div></td></tr></table><table align=\"center\" border=\"0\" cellpadding=\"0\" cellspacing=\"0\" class=\"\" role=\"presentation\" style=\"width:600px;\" width=\"600\" bgcolor=\"transparent\" ><tr><td style=\"line-height:0px;font-size:0px;mso-line-height-rule:exactly;\"><![endif]--><div style=\"background:0 0;background-color:transparent;margin:0 auto;max-width:600px\"><table align=\"center\" border=\"0\" cellpadding=\"0\" cellspacing=\"0\" role=\"presentation\" style=\"background:0 0;background-color:transparent;width:100%\"><tbody><tr><td style=\"direction:ltr;font-size:0;padding:0;padding-top:24px;text-align:center\"><!--[if mso | IE]><table role=\"presentation\" border=\"0\" cellpadding=\"0\" cellspacing=\"0\"><tr><td class=\"\" style=\"vertical-align:top;width:600px;\" ><![endif]--><div class=\"mj-column-per-100 mj-outlook-group-fix\" style=\"font-size:0;text-align:left;direction:ltr;display:inline-block;vertical-align:top;width:100%\"><table border=\"0\" cellpadding=\"0\" cellspacing=\"0\" role=\"presentation\" style=\"vertical-align:top\" width=\"100%\"><tbody><tr><td align=\"justify\" style=\"font-size:0;padding:0;padding-right:16px;padding-left:16px;word-break:break-word\"><div style=\"font-family:'Baloo 2',Helvetica,Arial,Sans-Serif;font-size:12px;font-weight:500;line-height:1.4;text-align:justify;color:#64748b\">Copyright @ MobyMoney 2022</div></td></tr></tbody></table></div></td></tr></table><![endif]--></td></tr></tbody></table></div><!--[if mso | IE]></td></tr></table><table align=\"center\" border=\"0\" cellpadding=\"0\" cellspacing=\"0\" class=\"\" role=\"presentation\" style=\"width:600px;\" width=\"600\" bgcolor=\"transparent\" ><tr><td style=\"line-height:0px;font-size:0px;mso-line-height-rule:exactly;\"><![endif]--><div style=\"background:0 0;background-color:transparent;margin:0 auto;max-width:600px\"><table align=\"center\" border=\"0\" cellpadding=\"0\" cellspacing=\"0\" role=\"presentation\" style=\"background:0 0;background-color:transparent;width:100%\"><tbody><tr><td style=\"direction:ltr;font-size:0;padding:0;padding-top:16px;text-align:center\"><!--[if mso | IE]><table role=\"presentation\" border=\"0\" cellpadding=\"0\" cellspacing=\"0\"><tr><td class=\"\" style=\"vertical-align:top;width:600px;\" ><![endif]--><div class=\"mj-column-per-100 mj-outlook-group-fix\" style=\"font-size:0;text-align:left;direction:ltr;display:inline-block;vertical-align:top;width:100%\"><table border=\"0\" cellpadding=\"0\" cellspacing=\"0\" role=\"presentation\" style=\"vertical-align:top\" width=\"100%\"><tbody><tr><td align=\"center\" style=\"font-size:0;padding:0;padding-right:16px;padding-left:16px;word-break:break-word\"><div style=\"font-family:'Baloo 2',Helvetica,Arial,Sans-Serif;font-size:14px;font-weight:500;line-height:1.4;text-align:center;color:#334155\"><a style=\"color:#c026d3;font-weight:700;padding-right:.8rem\" href=\"\" target=\"_blank\"></a><a style=\"color:#c026d3;font-weight:700;padding-right:.8rem\" href=\"\" target=\"_blank\"></a><a style=\"color:#c026d3;font-weight:700;padding-right:.8rem\" href=\"\" target=\"_blank\"></a><a href=\"{{platform::company::whatsapp:url}}\" target=\"_blank\" style=\"color:#c026d3;font-weight:700\"></a></div></td></tr></tbody></table></div><!--[if mso | IE]></td></tr></table><![endif]--></td></tr></tbody></table></div><!--[if mso | IE]></td></tr></table><table align=\"center\" border=\"0\" cellpadding=\"0\" cellspacing=\"0\" class=\"\" role=\"presentation\" style=\"width:600px;\" width=\"600\" bgcolor=\"transparent\" ><tr><td style=\"line-height:0px;font-size:0px;mso-line-height-rule:exactly;\"><![endif]--><div style=\"background:0 0;background-color:transparent;margin:0 auto;max-width:600px\"><table align=\"center\" border=\"0\" cellpadding=\"0\" cellspacing=\"0\" role=\"presentation\" style=\"background:0 0;background-color:transparent;width:100%\"><tbody><tr><td style=\"direction:ltr;font-size:0;padding:0;padding-bottom:32px;padding-top:16px;text-align:center\"><!--[if mso | IE]><table role=\"presentation\" border=\"0\" cellpadding=\"0\" cellspacing=\"0\"><tr><td class=\"\" style=\"vertical-align:top;width:600px;\" ><![endif]--><table border=\"0\" cellpadding=\"0\" cellspacing=\"0\" role=\"presentation\" style=\"vertical-align:top\" width=\"100%\"><tbody><tr><td align=\"center\" style=\"font-size:0;padding:0;padding-right:16px;padding-left:16px;word-break:break-word\"><div style=\"font-family:'Baloo 2',Helvetica,Arial,Sans-Serif;font-size:12px;font-weight:500;line-height:1.4;text-align:center;color:#64748b\"></div></td></tr><tr><td align=\"center\" style=\"font-size:0;padding:0;padding-top:8px;padding-right:16px;padding-left:16px;word-break:break-word\"><div style=\"font-family:'Baloo 2',Helvetica,Arial,Sans-Serif;font-size:12px;font-weight:500;line-height:1.4;text-align:center;color:#64748b\"></div></td></tr></tbody></table></div></td></tr></tbody></table></div></div></body></html>\r\n";
            Base64 base64 = new Base64();
            String htmlMsg = valueFromDB.get(GlobalConstants.MAILGUN_MAIL_TEMPLATE);
//            String decodedString = new String(base64.decode(htmlMsg.getBytes()));
            String updatedHtml = htmlMsg.replaceAll("experian::fail_log", message);
            Mail.using(configuration)
                    .to(valueFromDB.get(GlobalConstants.MAILGUN_TO_EMAILS))
                    .subject("Payment Error Log")
                    .html(updatedHtml)
                    .build()
                    .send();
        } catch (Exception e) {
            log.error(e.getLocalizedMessage());
        }

    }
	
}
